# TCP/IP模型

不同设备间的进程通信，需要通过网络。设备是多样的，要兼容各种设备，于是推出了一套通用的网络协议。相当于推出了一套通用接口，设备只要实现这个接口就能加入网络通信

网络协议是分层的，每一层都有各自的作用和职责

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/tcpip%E5%8F%82%E8%80%83%E6%A8%A1%E5%9E%8B.drawio.png)

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost3@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%B5%AE%E7%82%B9/%E5%B0%81%E8%A3%85.png)

## 应用层

我们开发人员直接接触到的就是应用层，应用软件都是在应用层做的实现。当两个应用层应用需要进行通信时，就把应用数据传给传输层

应用层工作在os用户态，传输层工作在os内核态

应用层负责**为用户提供应用功能**

调用传输层接口将数据从一个应用传输给另一个应用，并通过数据为用户提供功能

### HTTP

在计算机世界专门在两点间传输超文本数据的约定和规范

#### 常见状态码

- 1xx 
  - 提示信息
  - 一般是协议处理的中间状态，实际使用较少
- 2xx
  - 表示服务器成功处理了客户端请求
  - 200 OK，表示请求成功，一切正常
  - 204 No Content，表示请求成功，但没有body数据
  - 206 Partial Content，用于分块下载或断点续传，表示相应返回的body并不是资源的全部，而是一部分
- 3xx
  - 表示客户端请求的资源发生了变动，需要客户端用心的Url重新发送请求获取资源，就是重定向
  - 301 Moved Permanently，表示永久重定向
  - 302 Found， 表示临时重定向，说明请求的资源还在，但要用另一个Url访问
  - 301 302 会在请求头里使用 Location 指明后续要跳转的Url，浏览器自动重定向
  - 304 Not Modified，表示资源为修改，缓存重定向，告诉用户使用缓存资源
- 4xx
  - 表示客户端发送的报文有误，服务端无法处理
  - 400 Bad Request，表示请求有错误
  - 403 Forbidden，表示服务器禁止访问资源，而不是请求出错
  - 404 Not Found，表示请求的资源不存在或未找到
- 5xx
  - 表示客户端请求报文正确，但服务处理时内部发生了错误
  - 500 Internal Server Error，表示服务端内部发生错误
  - 501 Not Implemented， 表示客户端请求的功能还不支持
  - 502 Bad Gateway，服务器工作正常，但访问后端服务器发生了错误
  - 503 Server Unavailable， 表示服务器当前很忙，暂时无法响应

#### 请求头

- Host 指定服务器域名，可将请求发往同一台服务器不同网站
- Content-Length 表示返回的数据长度
- Connection 标识是否启用了长连接
- Content-Type 标识相应是什么格式
- Content-Encoding 标识服务器返回的数据使用了什么压缩算法
- Accept-Encoding 标识客户端可接受哪些压缩算法

#### 请求方法

- GET
  - 从服务器获取资源
  - 参数一般在URL，URL支支持ASCII字符，且URL长度有限制
  - 只读操作，安全且幂等。GET请求到的数据可以缓存
  - GET请求也可以带body
- POST
  - 根据请求负荷对指定资源作出处理
  - 携带的数据和参数一般在body中，可以是任易格式
  - 不安全，会修改服务器上的资源
  - 不幂等，多次提交会创建多个资源

#### HTTP特性

##### HTTP/1.1

- 简单，报文格式就是header + body。header 是 key value形式，易于理解
- 灵活，请求方法、url、状态码、头字段的定义都没有写死，可由开发人员自定义和扩充。
- 易扩展，加上SSL/TLS实现安全传输的HTTPS
- 应用广泛和跨平台
- 长连接，三次握手后可以持久通信
- 管道网络传输，没有默认使用。发送请求可以不等上一个请求返回。但是服务器要顺序处理，可能会队头阻塞

##### HTTP/1.1缺点

- 无状态，好处是占用资源少，坏处是没有记忆功能，完成关联性操作很麻烦
  - cookie通过在请求和响应报文中加入Cookie来控制客户端状态
- 明文传输，不安全
- 无法验证报文完整性，可能被篡改

#### HTTP缓存技术

#### 版本演变

#### 1.1

- 增加了长连接，避免了短连接的性能开销
- 支持管道

#### 2

- 基于https，安全
- 头部压缩，不同请求使用相同请求头，消除重复部分
- 二进制格式，增加传输效率
- 并发传输
- 服务器主动推送资源，减少消息传递次数

#### 3

- UDP传输，无队头阻塞
- 更快建立连接

### HTTPS

解决http安全问题

#### 区别

- http报文明文传输，https报文加密传输
- https在tcp三次握手后还要进行ssl/tls三次握手
- http默认端口80，https默认端口443
- https要向CA申请数字证书来保证服务器信息是可信的

#### 特性

- 信息加密，通信的数据无法被窃取。通过混合加密
- 校验机制，使得第三方无法篡改通信内容。通过摘要算法
- 身份证书，证明服务器身份，防止服务冒充。通过数字证书

#### 混合加密

##### 流程

1. 服务端将公钥发送给客户端，将私钥保留
2. 客户端得到公钥，通过公钥对密钥进行加密，然后将加密数据发送给服务端
3. 服务端通过私钥解密加密数据获得密钥
4. 后续流程请求响应的数据都由密钥加密
5. 服务端通知客户端收到密钥
6. 客户端发送后续请求

##### 特点

- 非对称加密和对称加密结合的加密方式
- 通信建立前采用非对称加密交换会话密钥，安全性高
- 通信过程中采用对称加密来加密明文数据，速度快

#### 摘要算法

- 通过数字签名来保证消息不被篡改
- 对内容的哈希值加密
- 服务端用私钥加密数据，客户端收到消息如果可用公钥解密，说明数据是由服务端发送的

#### 数字证书

- 仅有摘要算法无法解决第三方冒充服务端
- 使用CA作为第三方认证机构
  1. 服务端把公钥注册到CA
  2. CA用自己的私钥将服务端的公钥做数字签名，并颁发数字证书
  3. 客户端拿到服务端数字证书，使用CA公钥确认数字证书真实性
  4. 使用数字证书的公钥进行混合加密传输

#### TLS握手

1. 客户端发起加密请求
   - 客户端支持的TLS版本号
   - 客户端产生随机数
   - 客户端支持的加密算法
2. 服务端返回加密请求相应
   - 确认TLS版本，如果浏览器不支持，则关闭加密通信
   - 产生随机数
   - 确认加密算法
   - 数字证书
3. 客户端回应
   - 通过CA公钥确认证书真实性，并从中取出公钥
   - 一个随机数，使用公钥加密
   - 使用服务端指定的加密算法
   - 数据摘要
4. 服务端回应
   - 通知客户端随后通信都用会话密钥加密
   - 服务端信息摘要

## 传输层

应用层数据会传输给传输层，传输层为应用层提供网络支持。

传输层负责**将数据从一个应用传输给另一个应用**

调用网络层接口将数据从一个设备传输给另一个设备，**通过端口**将数据发送给指定应用

### TCP

#### 特点

- 传输控制协议
- 大部分应用层协议基于TCP
- 流量控制、超时重传、拥塞控制保证数据包可靠的传输给对方

#### TCP段

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/https/TCP%E6%AE%B5.png)

应用需要传输的数据可能很大，如果直接传输不好控制，所以会将数据分包。这样大文件传输中途只有一个分包损坏，只需重传这一个分包。将这个分包称之为TCP段（TCP Segment

#### 端口

一台设备可能有很多进程在接收或传输数据，需要用一个编号将应用区分开，这个编号就是端口。传输层接收方根据端口识别报文是发送给哪个应用的。

- 常用端口
  - 80 http
  - 22 ssh 远程登陆
  - 浏览器每个标签页一个独立进程，os为其分配单独的临时端口号

### UDP

#### 特点

- 简单负责发送数据包，不保证数据包是否能抵达对方，实时性更好，传输效率更高
- 通过把TCP的特性在基于UDP的应用在应用层实现，UDP也可实现可靠传输

## 网络层

网络层负责**将数据从一个设备传输给另一个设备**

调用网络接口层，通过**IP**将数据发送给指定设备

### IP

#### IP数据报

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/12.jpg)

- IP协议将传输层的报文作为数据部分，再加上IP包组成IP报文

- 如如果IP报文超过MTU大小，会将IP报文再次分片。

#### IP地址

- 通过IP对设备进行编号
- IP地址分为网络号和主机号
- 先匹配网络号找到子网，再去子网通过主机号找设备

#### 路由

- 设备间是通过复杂拓扑结构连接起来的，两点通信有很多条路径，需要通过路由算法决定走那个路径
- 先找到目标地址的子网，然后把数据包转发给对应的网络

## 网络接口层

网络接口层负责为网络层提供链路级别的传输服务，负责在以太网、WiFi这样的底层网络上发送原始数据包，网卡工作在这个层次

通过Mac标识网络上的设备

# TCP

TCP时面向连接的，可靠的，基于字节流的传输层通信协议

- 面向连接，指传输是一对一的，不能广播组播
- 可靠的，保证一个报文到达接收端，有重试机制
- 字节流，传输的消失是字节数组

TCP工作在传输层，解决在设备间通信的问题，保证数据的按序交付和完整性

## TCP头

- 序列号：建立连接时生成的随机数，通过SYN包传给接收端主机，没法送一次数据，就累加一次该数据字节数大小，解决网络包**乱序问题**
- 确认应答号：指下次期望收到的数据的序列号，发送端收到这个确认应答以后可以认为在这个需要以前的数据都已经被正常接收，解决**丢包问题**
- 控制位
  - ACK，为1时，确认应答的字段变为有效，TCP规定除了最初建立连接时的SYN包之外该位必须设置为1
  - RST，为1时，表示TCP连接中出现异常必须强制断开连接
  - SYN，为1时，表示希望建立连接，并在其序列号的字段进行序列号值初始化
  - FIN，为1时，表示今后不会再有数据发送，希望断开连接。

## TCP连接

用于保证可靠性和流量控制维护的某些状态信息，包括Socket、序列号和窗口大小等信息的组合

- Socket有IP地址和端口号组成，标识设备地址和目标进程
- Linux霞netstat -napt查看连接
- 序列号用来解决乱序问题
- 窗口大小用于做流量控制
- 使用四元组确定一个唯一的连接
  - 源地址
  - 源端口
  - 目标地址
  - 目标端口
- 源地址和目的地址在IP头部，用于网络层IP协议指定目标设备
- 源端口和目的端口在TCP头部，用于传输层指定目标进程
- 连接数受限制
  - 文件描述符限制，系统级用户级进程级都存在限制
  - 内存限制，TCP连接占用内存，内存占用满会OOM

## UDP区别

UDP不提供复杂的控制机制，利用IP提供面向无连接的通信服务

### UDP头部

- 目标端口和源端口，用于标识传输层UDP协议目标设备地址
- 包长度，保存了UDP首部长度和数据长度
- 校验和，防止收到网络中受损的UDP包

#### 区别

- TCP面向连接，UDP不需要连接
- TCP用于点对点的服务，一条连接只有两个端点。UDP支持一对一、一对多、多对多的交互通信
- TCP可靠交付，按序不丢失不重复送达，UDP不保证
- TCP有拥塞控制和流量控制，保证数据安全性。UDP无视网络拥堵
- TCP首部开销大，UDP首部开销小
- TCP是流式传输，UDP是按包发送，但可能会丢包乱序

#### 应用场景

- ##### TCP

  - 由于面向连接且数据可靠，常用于FTP文件传输
  - HTTP服务

- UDP

  - 包总量少的通信
  - 视频、音频等多媒体通信
  - 广播通信

## 三次握手

### 建立连接的过程

1. 服务端调用listen()监听端口号
2. 客户端指定端口发发起连接，生成SYN报文
   1. 初始化随机序列号client_isn
   2. SYN同步标志设置为1，表示这是一条SYN报文请求建立连接
   3. 报文发送给服务端
3. 服务端收到SYN报文后，知道客户端要建立连接，生成SYN+ACK报文
   1. 初始化随机序列号server_isn
   2. ACK和SYN首部改为1
   3. 确认应答号改为 client_isn + 1
   4. 报文发送给客户端
   5. 服务端进入SYN_RCVD
4. 客户端发送ACK报文
   1. ACK首部改为1
   2. 确认应答号改为 server_isn + 1
   3. 写入数据
   4. 报文发送给服务端
   5. 客户端进入ESTABLISH

### QA

#### 两次连接不行吗

- 避免历史连接，不造成资源浪费
  - 两次握手无法阻止历史连接
  - 只有两次握手情况下若客户端因为网络原因重发SYN报文，服务端会建立无效连接
- 同步双方序列号
  - 用来保证TCP按序到达
  - SYN请求需要有ACK
  - 服务端发送的SYN+ACK报文携带了序列号，客户端收到序列号要发送应答报文给服务端

为什么每次建立连接TCP初始化序列号不一样

- 防止历史报文被相同四元组连接接收
- 防止黑客伪造相同序列号报文

#### 握手丢失

##### 第一次丢失

- 客户端会发现收不到SYN+ACK报文，触发超时重传，超时重传序列号一样
- 超时时间写死在内核，不同os不同，有1s、 3s等
- 重传次数可自定义，默认值为5
- 每次超时时间翻倍

##### 第二次握手丢失

- 客户端超时重传SYN
- 服务端超时重传SYN+ACK

##### 第三次握手丢失

- 由服务端重传并等待ACK，还收不到就断开连接

### SYN攻击

攻击者短时间伪造不同IP地址的SYN报文，占满服务端的半连接队列，是的其他SYN不能服务

- 调大网卡数据包队列
- 调大TCP半连接队列
- 减少SYN+ACK重传次数

## 四次挥手

TCP通过四次挥手断开连接，释放连接资源

### 挥手过程

1. 客户端发送FIN报文，进入FIN_WAIT_1状态
2. 服务端收到FIN，发送ACK报文，进入CLOSE_WAIT
3. 客户端收到报文，进入FIN_WAIT_2
4. 服务端处理完数据，发送FIN报文，然后进入LAST_ACK
5. 客户端收到FIN，发送ACK，进入TIME_WAIT
6. 服务端收到ACK，进入CLOSE，关闭成功
7. 客户端经过2MSL，进入CLOSE，关闭成功

每个方向都需要有一个FIN和一个ACK。主动关闭连接的才有TIME_WAIT

### QA

#### 为什么要四次

- 关闭连接时，客户端可能还要接收数据，因此服务端先发送ACK表示收到FIN，再发送FIN表示同意关闭

#### 第一次挥手丢失

- 客户端超时重传FIN

#### 第二次挥手丢失

- 服务端ACK不会超时重传
- 客户端超时重传FIN

#### 第三次挥手丢失

- 客户端ACK不会超时重传
- 服务端超时重传FIN

#### 第四次挥手丢失

- 客户端ACK不会超时重传
- 服务端超时重传FIN

# IP

IP是网络层协议，用于实现网络层点对点的通信

## IP地址的表示

- 32位二进制表示
- 点分十进制形式，每8位2进制分为一组，再转为十进制

### IP地址分类

IP可分为网络地址部分和主机地址部分

主机地址全为1指定某个网络下的所有主机，用于广播，对指定网络地址所有主机发送数据

- 本地广播：在本网络内广播
- 直接广播：在不同网络内广播

地址分五类

- A类地址
  - 8位网络地址 + 24位主机地址
  - 广域网
- B类地址
  - 16位网络地址+16位主机地址
  - 城域网
- C类地址
  - 24位网络地址+8位主机地址
  - 局域网
- D类地址
  - 没有主机号
  - 常用于多播
- E类地址
  - 没有主机号
  - 预留分类，暂不使用

### 无分类地址CIRD

a.b.c.d/x 

/x表示前x位属于网络号，x的范围是0~32

使IP更加灵活

#### 子网掩码形式

将子网掩码与IP与运算，得到网络号

## IP协议栈

### DNS

上网时，域名代替IP地址，方便人类记忆

通信时，需要将域名转化为IP地址进行寻址

#### 域名层级关系

域名使用 . 分割，越靠右表示层级越高

最顶层是根DNS服务器，整体是一个树状结构

1. 根DNS服务器
   - 根域DNS服务器信息保存在互联网中所有的DNS服务器中，任何DNS服务器都可以找到并访问根域DNS服务器
2. 顶级域DNS服务器
3. 权威DNS服务器

#### 域名解析工作流程

1. 浏览器依次查看本地缓存、os缓存、hosts文件。如果都没有则下一步
2. 发送DNS请求给本地DNS服务器，查询域名对应IP
3. 本地DNS服务器查看本地缓存数据，找到直接返回，否则发送请求给根域服务器
4. 根域DNS服务器根据后缀返回对应的DNS知名顶级域名服务器地址
5. 本地DNS收到顶级域名服务器地址后向其发送请求，查询域名对应IP
6. 顶级域名服务器地址返会权威DNS服务器地址
7. 本地DNS去问权威服务器，返回目的IP

### ARP

传输IP数据报时，通过路由表确定IP包下一跳，还要通过ARP知道MAC地址才能制动走哪个链路

通过ARP请求与ARP响应确定MAC地址

#### ARP广播

- 主机通过广播发送ARP请求，请求包含目标IP地址
- 同一个链路所有设备收到ARP请求，判断与自己IP是否一致，一致则返回ARP响应
- MAC会被缓存

#### RARP

- 已知MAC求IP

### DHCP

用于动态获取IP地址

1. 客户端发起 **DHCP发现** 报文，**广播**给所有链路
2. DHCP服务器收到DHCP发现报文，返回**DHCP提供报文**。使用广播发送IP地址、子网掩码、默认网关、DNS服务器和IP地址租用期
3. 客户端收到DHCP提供报文，从中选一个，并发送**DHCP请求报文**，回显配置的参数
4. 服务端返回**DHCP ACK**报文，应答所要求的参数

### NAT

提供网络地址转换缓解IPv4地址耗尽的问题

### ICMP

互联网控制报文协议

- 确认IP包是否成功送达目标地址
- 报告发送过程中IP包被废弃的原因和改善网络设置

### IGMP

# QA

## 输入网址到显示网页的流程

1. 解析URL
   - 协议 + 服务器地址 + 资源路径
2. 根据URL生成HTTP请求报文
   - 请求报文 = 请求行 + 请求头 + 请求体
   - 请求行 = 方法 + URL + 版本
   - 请求头 = []{首部字段:字段值}
   - 请求体 = 数据
3. DNS获取服务器IP地址
   - URL中输入的服务器地址可能是域名地址，需要将其解析为IP地址
4. HTTP请求报文封装为TCP段，HTTP报文太长则会分为多个TCP段
   - ![TCP 层报文](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/13.jpg)
   - 源端口和目标端口，用于传输层确定目标进程
   - 包序号，解决包乱序问题
   - 确认号，确认发出去对方是否收到，解决丢包问题
   - 状态位，维护TCP连接
   - 窗口大小，标识报文发送者处理数据的能力，实现流量控制

5. TCP段封装为IP报文
   - ![IP 层报文](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/17.jpg)
   - 源IP和目的IP，用于网络层确定目标网络

6. IP报文头部加上MAC头部，用于数据链路层确定目标网卡
   - ![MAC 层报文](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/21.jpg)
   - MAC地址可通过ARP协议获得

7. 通过出口网卡将数据发送出去
8. 通过交换机
9. 通过路由器
10. 发送至子网，通过mac确定设备，通过端口号确定进程，用HTTP解析报文，结束

## Ping原理

# 计算机网络

## 基本概念

- 网络：由若干节点和连接这些节点的链路组成的网
- 互联网（internet）：多个网络可通过路由器互连起来，构成一个覆盖范围更大的网络即互联网，互联网是网络的网络。
  - 互联网是一个通用名词，泛指由多个计算机网络互连而成的网络，这些网络间的通信协议可以是任意的
- 因特网（Internet）：因特网是世界上最大的互联网络，专指当前全球最大的、开放的、由众多网络互相连接而成的特定计算机网络，
  - 采用TCP/IP作为通信协议，前身是美国的ARPANET
- ISP因特网服务提供者
  - 电信联通移动
  - ISP三层结构
    - 第一层ISP，是因特网主干网。主要用于国际性区域，拥有告诉链路和交换设备。第一层ISP间直接互联
    - 第二层ISP用于区域或国家性覆盖规模
    - 第三层本地ISP
- 因特网的组成
  - 边缘部分，有所有连接在因特网上的主机组成。用户可直接使用，用来进行通信和资源共享
  - 核心部分，有大量网络和连接网络的路由器组成，为边缘提供服务
- 速率
  - 主机在数字信道上传送比特的速率
- 带宽
  - 网络的通信线路所能传送数据的能力，表示单位时间内从网络中的某一点到另一点通信的最高数据率
- 吞吐量
  - 单位时间内通过某个网络的数据量
- 网络时延
  - 发送时延：数据发送至通信链路。分组长度/发送速率
  - 传播时延：路由期间链路传播。信道长度/电磁波传播速率
  - 处理时延：路由出处理分组。取决于网络拥堵程度和路由器性能

## 体系结构

- OSI体系结构
  - 法律上的国际标准
  - 设计时缺乏经验
  - 过于复杂，运行效率低
  - 层次划分不合理
- TCP/IP体系结构
  -  商业上的国际标准
  - 将数据链路层和物理层合并为网络接口层
  - 取消会话层和表示层
- 原理体系结构
  - 将TCP/IP的网络接口层重新划分为物理层和数据链路层
  - 目的是理清楚原理

![image-20240709194115759](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240709194115759.png)

# 物理层和数据链路层

## 集线器

- 相当于共享总线结构
- 一台主机发送单播帧时，单播帧会传播到总线上个主机
- 主机接收到单播帧后，网卡根据帧的目的MAC地址决定是否接收帧
- 集线器互联仍是一个广播域和一个碰撞域
- 市场上已经淘汰

## 交换机

- 工作在物理层和数据链路层
- 根据MAC地址对帧进行转发
- 主机发送单播，只能先传播到交换机
- 交换机收到帧后，根据目的MAC地址查表决定将帧发送给哪个主机
- 交换机可以隔离碰撞域，不能隔离广播域。每一个端口形成一个碰撞域

## 数据链路层

通过mac地址在同一网络内的链路上传播

通过ip地址在不同网络上传播

仅知道ip不能让数据链路层定位到具体设备，数据链路层需要依靠mac地址来发送单播，实现通信

可通过ARP协议在知道目标IP的情况下，获得链路上接口的mac

### MAC地址

- 用来解决数据在同一个网络（或者说链路）上运输的问题
- 当多个主机连接在同一个广播信道上、要想实现两个主机间的通信，则每个主机都必须有一个唯一标识，即数据链路层地址
- 在每个主机发送的帧中必须携带标识发送主机和接收主机的地址，成为MAC地址
- MAC地址一般与网卡固定，有时也称物理地址，属于数据链路层
- MAC地址对应网络上各接口的唯一标识，而不是各设备的唯一标识

## IP地址

IP地址是因特网上的主机和路由器所使用的地址，用于标识两部分信息，

- 用来解决数据在不同网络间传输的问题
- 网络编号，标识因特网上数以百万计的网络
- 主机编号，标识同一网络上的不同主机（或路由器各接口）

![image-20240709204605097](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240709204605097.png)

- 数据包从一个设备转发至另一个设备过程中，源IP地址和目的IP地址不变
- 源MAC地址和目的MAC地址逐个（网络）链路改变

## ARP协议

1. 目的是通过IP地址找MAC地址，有了MAC地址在数据链路层实现端到端的通信
2. 源主机在自己ARP高速缓存表中用Ip查找对应的MAC，如果找不到MAC则向链路层发送广播ARP请求报文，标识自己的IP、MAC地址和寻找的MAC地址
3. 目的主机收到后，将IP和MAC记录到自己的ARP高速缓存表中，然后用单播向源主机发送ARP相应，响应标识自己的IP和MAC
4. 源主机收到后，将数据记录到本地ARP高速缓存表，然后通过MAC地址在数据链路层将数据封装成帧发送给目的主机
5. ARP只能在设备的本地链路上使用，不能跨网络（路由器不转发ARP广播
6. ARP有其他类型报文、没有安全机制

# 网络层

## 主要协议

- IP 网际协议
- ARP 地址解析协议
- ICMP 网际控制报文协议
- IGMP 网际组管理协议

## 网络层主要任务

实现网络互联，进而实现数据包在网络之间的传输

## 主要问题

- 网络层向上层提供怎样的服务
  - 可靠传输
  - 不可靠传输（TCP/IP的实现）
- 网络层寻址问题
  - 怎样根据IP定位到所在网络并通过路由器转发分组
- 路由选择问题
  - 两个网络间有多个路径，如何选择路径
    - 一句数据包中目的地址和路由表
    - 路由表中记录的目的网络到下一跳路由器地址的映射
    - 路由表可配置，但主要由路由选择协议中的路由选择算法实现

## 无连接的数据报服务

提供无连接的不可靠的服务

- 可靠通信由用户主机保证
- 不需要建立网络层连接
- 每个分组可以走不同路径
- 每个分组的首部必须携带目的主机的完整地址
- 所传送的分组可能存在误码、丢失、重复和失序
- 将复杂的功能置于边缘（即用户主机），造价较低

## IP如何提供数据报服务

### IP地址

#### 按类分址

![image-20240709214415310](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240709214415310.png)

- A、B、C、D、E类地址
- 只有ABC类地址可以分配给网络中的主机或路由器各接口
- 主机号为全0的地址是网络地址，不能分配
- 主机号全为1的地址是广播地址，不能分配

#### 划分子网的IPv4地址

按类分址中将IP地址分为网络号和主机号

由于不够灵活，可以进一步将主机号中前几位划分为子网号

IP地址 = 网络号 + 子网号 + 主机号

#### 无分类编址

CIDR编址 

#### 路由聚合

CIDR取前缀

### IP转发

1. 源主机将目的主机IP地址与源主机所在子网源码相与，计算出目的主机与自己是否在同一子网
   1. 如果在同一子网，不经过路由转发，通过数据链路层通信
2. 源主机将数据转发给路由器入口地址（默认网关地址，配置在了主机上）
3. 路由器根据IP数据报中的目的IP查找路由表，转发至目标网络
   1. 如果路由器与子网直连，则直接通过数据链路层转发
   2. 否则转发至下一跳显示的路由器
4. 将IP数据包转发给目的子网，目的子网通过IP找MAC，然后转发至指定主机

#### 分层次路由选择协议

自治域内部使用内部网关协议IGP

- 路由信息协议RIP
  - 基于距离向量
  - 最早在因特网上使用
  - 最大15跳，超过不可达，适用于小型网络
- 内部网关路由协议IGRP
  - 基于距离向量
  - 被EIGRP取代
- 增强型内部网关路由协议EIGRP
  - 基于距离向量和链路状态
- 开放式最短路径优先OSPF
  - 基于链路状态
  - 在网络中广泛使用
- 中间系统到中间系统IS-IS
  - 基于链路状态
  - 在骨干网最常用

自治域间使用外部网关协议EGP

- 边界网关协议BGP

## IP数据报格式

![image-20240709230036856](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20240709230036856.png)

- 固定部分20字节
  - 版本 4bit，标识通信双方使用的IP协议版本，广泛使用的是4
  - 首部长度 4bit，标识IP数据报首部的长度
    - 最小十进制取值为5，表示IP数据报首部只有20字节固定部分
    - 最大十进制取值为15，表示IP数据报首部包含20字节固定部分和最大40字节可变部分
  - 区分服务 8bit，用来区分不同服务等级，一般不使用
  - 总长度，表示IP数据报总长度（首部+数据载荷），最大65535，以字节为单位
  - 标识 16bit，属于同一份IP数据报拥有相同标识
  - 标志 3bit
    - 第一个bit标识是否允许分片
    - 第二个bit标识是否是最后一个分片
    - 第三个保留置为0
  - 片偏移 13bit，指出分片数据报在原数据报的位置有多少单位，以8B为单位
  - 生存时间TTL 8bit，超过TTL（为零）就丢弃，否则转发
  - 协议 8bit，指明数据部分是何种数据单元
    - 1 ICMP报文
    - 2 IGMP报文
    - 6 TCP报文
    - 17 UDP报文
    - 41 IPv6报文
    - 89 OSPF报文
  - 首部检验和 16bit，IPv6路由器不再检验
  - 源IP目的IP各32bit
- 可变部分最大40字节
  - 长度从1到40个字节不等，用来支持排错、测量及安全等措施。为 (首部长度 - 5 ) * 4
  - 可选字段增加了IP数据报的功能，但也增加了开销。
  - 实际上很少被使用
  - 填充确保长度是4字节整数倍，全零填充

## ICMP

- 为了更有效的转发IP数据报和提高成功交付的机会，在网络层使用ICMP
- 主机或路由器使用ICMP来发送差错报告报文和查询报文，发送时被封装为IP数据报
- ICMP差错报告报文
  - 终点不可达
    - 当路由器或主机不能交付数据时，就向源点发送终点不可达报文
    - 根据ICMP的载荷，又可将ICMP细分为13种
      - 目的网络不可达
      - 目的主机不可达
      - 目的协议不可达
      - 目的端口不可达
      - 。。。
  - 源点抑制
    - 当主机或路由器由于拥塞而丢弃数据时，就向源点发送源点抑制报文
    - 源点收到此报文知道应当放慢发送频率
  - 时间超过
    - 路由器由于TTL全为0而丢弃报文，则向源主机发送该报文
    - 终点在规定时间内没有收到一个数据报的全部报文时，会将已收到的丢弃，并发送时间超过报文
  - 参数问题
    - 查看校验和发现出现误码则向源发送参数问题报文
  - 改变路由
    - 让主机下次选择更好的路由器
- ICMP查询报文
  - 回送请求报文+回答报文
    - 源主机向目的主机发出回送请求报文
    - 目的主机必须给源主机发送回答报文
    - 用来测试目的站是否可达，以及状态信息
  - 时间戳请求和回答
    - 用来进行时钟同步和测量时间

### ICMP应用

#### Ping

- 分组网间探测
- 用来测试主机或路由器间的连通性
- 直接使用网际层的ICMP而不使用TCP或UDP
- 使用了ICMP的查询报文中的回送请求+回答报文

#### traceroute

- 用来测试IP数据报从源主机到达目的主机要经过那些路由器
- 使用ICMP协议的回送请求+回答报文以及差错报告报文

## VPN和NAT

# 运输层

网络接口层、网络层解决了将主机通过异构网络互联，实现了主机到主机间的通信

运输层则提供让不同主机间的应用进程实现通信

运输层提供两种协议

## 端口号

- 运行在计算机上的进程使用进程标识符来标志
- 不同OS进程标识符不一致，传输层需要使用统一方法对应用进程进行标识
- 使用端口号进行标识不同应用进程
- 端口号16 bit，取值为0~65535
  - 0~1023指派给 TCP/IP 体系中一些重要的应用层协议，如FTP使用21和20，HTTP使用80，DNS使用53
  - 1024~49151登记端口号
  - 49152~65535短暂端口号，给用户进程短暂使用

## 两个协议区别

- UDP无连接服务，TCP面向连接且全双工通信
- UDP支持单播、多播、广播。TCP面向连接，只能一对一通信
- UDP对应用层交付的报文直接打包，TCP面向字节流
- UDP尽可能交付，但不可靠，没有流量控制拥塞控制。TCP可靠传输，有流量控制和拥塞控制
- UDP首部仅8字节，TCP首部20~60字节

## TCP



### 流量控制

TCP是面向连接的服务，如果发送方速度太快，接收方来不及接收，会造成数据丢失

TCP利用滑动窗口机制在TCP连接数实现对发送方的流量控制

### 拥塞控制



## UDP

